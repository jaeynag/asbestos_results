<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŒ€í•œí™˜ê²½ í˜„ì¥ì‹œìŠ¤í…œ v4</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --bg: #F2F2F7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        .page { display: none; padding: 15px; min-height: 100vh; }
        .page.active { display: block; }
        
        .card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; }
        h2 { font-size: 1rem; margin: 0 0 12px 0; color: #1c1c1e; border-left: 4px solid var(--primary); padding-left: 8px; }

        label { display: block; font-size: 12px; font-weight: 600; color: #8e8e93; margin-bottom: 4px; }
        input, select { 
            width: 100%; height: 44px; background: #F2F2F7; border: 1px solid #DDD; 
            border-radius: 8px; padding: 0 10px; font-size: 15px; margin-bottom: 10px; outline: none;
        }

        /* íƒ­ ë²„íŠ¼ */
        .tab-container { display: flex; background: #E5E5EA; border-radius: 10px; padding: 2px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 13px; cursor: pointer; color: #8E8E93; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* ì‹œë£Œ ë¦¬ìŠ¤íŠ¸ */
        .item-row { display: flex; align-items: center; justify-content: space-between; background: #fff; border-radius: 10px; padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; }
        .item-info { flex: 1; }
        .item-info b { display: block; font-size: 14px; }
        .item-info span { font-size: 11px; color: var(--primary); }
        
        .cam-btn { 
            background: #E8F2FF; color: var(--primary); border: 1px solid var(--primary); 
            min-width: 55px; height: 38px; border-radius: 6px; font-weight: bold; font-size: 12px; margin-left: 4px;
        }
        .cam-btn.done { background: var(--success) !important; border-color: #28a745 !important; color: white !important; }

        .nav-btn { width: 100%; height: 50px; border-radius: 10px; font-size: 16px; font-weight: bold; border: none; cursor: pointer; }
        .btn-next { background: var(--primary); color: white; margin-top: 10px; }
        .btn-add { background: #444; color: white; margin-top: 5px; height: 40px; font-size: 14px; }
    </style>
</head>
<body>

<div id="page1" class="page active">
    <div class="card">
        <h2>ğŸ—ï¸ í˜„ì¥ ì •ë³´</h2>
        <label>ğŸ¢ ì†Œì† ì—…ì²´</label>
        <select id="company_id"></select>
        <label>ğŸ“ ê³µì‚¬ëª… (ê°€ëª… ê°€ëŠ¥)</label>
        <input type="text" id="site_name" placeholder="í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        <label>ğŸ‘· ì¸¡ì •ì</label>
        <input type="text" id="inspector_name" placeholder="ì„±í•¨">
        <button class="nav-btn btn-next" onclick="goPage(2)">ë‹¤ìŒ (ì‹œë£Œ ì…ë ¥) ã€‰</button>
    </div>
</div>

<div id="page2" class="page">
    <div class="tab-container">
        <div id="tab-nong" class="tab active" onclick="switchMode('ë†ë„')">ì„ë©´ ë†ë„</div>
        <div id="tab-bi" class="tab" onclick="switchMode('ë¹„ì‚°')">ë¹„ì‚° ì •ë„</div>
    </div>

    <div class="card">
        <h2>ğŸ“… ì¸¡ì • ë‚ ì§œ & í¬ì¸íŠ¸</h2>
        <label>ë‚ ì§œ ì„ íƒ</label>
        <input type="date" id="measure_date">

        <div id="form-nong">
            <label>ì¸¡ì • ìœ„ì¹˜ (ì§€ì ëª…)</label>
            <input type="text" id="loc_nong" placeholder="ì˜ˆ: P1, ê±°ì‹¤">
            <label>ì‹œì‘ ì‹œê°„</label>
            <input type="time" id="time_nong">
        </div>

        <div id="form-bi" style="display:none;">
            <label>ìƒí™© ì„ íƒ</label>
            <select id="bi_status" onchange="updateBiPoints()">
                <option value="ì‚¬ì „">1. ì‚¬ì „ì¸¡ì •</option>
                <option value="ì² ê±°">2. ì² ê±°(ì‘ì—… ì¤‘)</option>
                <option value="ë³´ê´€">3. íê¸°ë¬¼ ë³´ê´€</option>
            </select>
            <label>ì¸¡ì • ì§€ì  ì„ íƒ</label>
            <select id="loc_bi"></select>
            <label>ì‹œì‘ ì‹œê°„</label>
            <input type="time" id="time_bi">
        </div>

        <button class="nav-btn btn-add" onclick="addItem()">+ ëª©ë¡ì— ì¶”ê°€</button>
    </div>

    <div id="list-container"></div>

    <button class="nav-btn btn-next" id="btn-finish" onclick="finishAll()" style="background:var(--success); margin-top:20px;">ì„œë²„ ì „ì†¡ ë° ì™„ë£Œ</button>
    <button onclick="goPage(1)" style="width:100%; background:none; border:none; color:#888; font-size:13px; margin-top:10px;">ã€ˆ ê³µì‚¬ ì •ë³´ ìˆ˜ì •</button>
</div>

<input type="file" id="cam-input" accept="image/*" capture="camera" style="display:none;" onchange="handleFile(this)">

<script>
    const S_URL = "https://zaivmmhooaqaifbkulcl.supabase.co";
    const S_KEY = "sb_publishable_xiOg7viV4LgelbuxPLzw3g_YR1YQ4zi";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let mode = 'ë†ë„';
    let items = [];
    let currentTarget = null;

    document.getElementById('measure_date').value = new Date().toISOString().substring(0, 10);

    const biPointsMap = {
        "ì‚¬ì „": ["ë¶€ì§€ê²½ê³„1", "ë¶€ì§€ê²½ê³„2", "ë¶€ì§€ê²½ê³„3", "ë¶€ì§€ê²½ê³„4"],
        "ì² ê±°": ["ë¶€ì§€ê²½ê³„1", "ë¶€ì§€ê²½ê³„2", "ë¶€ì§€ê²½ê³„3", "ë¶€ì§€ê²½ê³„4", "ìœ„ìƒì„¤ë¹„", "ìŒì••ê¸°ë°°ì¶œêµ¬", "ì‘ì—…ì¥ë‚´ë¶€", "ì‘ì—…ì¥ì£¼ë³€", "íê¸°ë¬¼ë°˜ì¶œêµ¬", "íê¸°ë¬¼ë³´ê´€ì†Œ"],
        "ë³´ê´€": ["íê¸°ë¬¼ë³´ê´€ì†Œ1", "íê¸°ë¬¼ë³´ê´€ì†Œ2"]
    };

    function goPage(n) {
        if(n===2 && !document.getElementById('site_name').value) return alert("í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('page'+n).classList.add('active');
        updateBiPoints();
    }

    function switchMode(m) {
        mode = m;
        items = []; renderList();
        document.getElementById('tab-nong').classList.toggle('active', m==='ë†ë„');
        document.getElementById('tab-bi').classList.toggle('active', m==='ë¹„ì‚°');
        document.getElementById('form-nong').style.display = m==='ë†ë„'?'block':'none';
        document.getElementById('form-bi').style.display = m==='ë¹„ì‚°'?'block':'none';
    }

    function updateBiPoints() {
        const status = document.getElementById('bi_status').value;
        const sel = document.getElementById('loc_bi');
        sel.innerHTML = "";
        biPointsMap[status].forEach(p => { sel.innerHTML += `<option value="${p}">${p}</option>`; });
    }

    function addItem() {
        const loc = mode === 'ë†ë„' ? document.getElementById('loc_nong').value : document.getElementById('loc_bi').value;
        const time = mode === 'ë†ë„' ? document.getElementById('time_nong').value : document.getElementById('time_bi').value;
        if(!loc) return alert("ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        items.push({ id: Date.now(), location: loc, time: time || "ì‹œê°„ë¯¸ì •", photo: null, photo_before: null, photo_after: null });
        renderList();
        if(mode==='ë†ë„') document.getElementById('loc_nong').value = "";
    }

    function renderList() {
        const container = document.getElementById('list-container');
        container.innerHTML = "";
        items.forEach(item => {
            const row = document.createElement('div'); row.className = 'item-row';
            let btns = mode==='ë†ë„' 
                ? `<button class="cam-btn ${item.photo?'done':''}" onclick="openCam(${item.id}, 'photo')">${item.photo?'âœ… ì™„ë£Œ':'ğŸ“· ì´¬ì˜'}</button>`
                : `<button class="cam-btn ${item.photo_before?'done':''}" onclick="openCam(${item.id}, 'photo_before')">${item.photo_before?'âœ… ì „':'ì „'}</button>
                   <button class="cam-btn ${item.photo_after?'done':''}" onclick="openCam(${item.id}, 'photo_after')">${item.photo_after?'âœ… í›„':'í›„'}</button>`;
            row.innerHTML = `<div class="item-info"><b>${item.location}</b><span>ì‹œì‘: ${item.time}</span></div><div>${btns}</div>`;
            container.appendChild(row);
        });
    }

    function openCam(id, type) { currentTarget = {id, type}; document.getElementById('cam-input').click(); }
    function handleFile(i) { if(i.files[0]) { items.find(x=>x.id===currentTarget.id)[currentTarget.type] = i.files[0]; renderList(); } }

    async function finishAll() {
        const btn = document.getElementById('btn-finish');
        btn.disabled = true;
        try {
            const { data: pData } = await supabaseClient.from('projects').upsert([{
                company_id: document.getElementById('company_id').value,
                site_name: document.getElementById('site_name').value,
                inspector_name: document.getElementById('inspector_name').value,
                measure_date: document.getElementById('measure_date').value,
                work_type: mode
            }], { onConflict: 'site_name' }).select();

            for(let item of items) {
                const ts = mode==='ë†ë„' ? ['photo'] : ['photo_before', 'photo_after'];
                for(let t of ts) {
                    if(!item[t]) continue;
                    const path = `${mode}/${document.getElementById('site_name').value}/${item.location}_${t}_${Date.now()}.jpg`;
                    const { data: sData } = await supabaseClient.storage.from('asbestos_photos').upload(path, item[t]);
                    await supabaseClient.from('project_photos').insert([{
                        project_id: pData[0].id, photo_type: `${item.location}_${t}`, storage_path: sData.path, description: item.time
                    }]);
                }
            }
            alert("ì „ì†¡ ì™„ë£Œ!"); location.reload();
        } catch (e) { alert("ì˜¤ë¥˜: "+e.message); btn.disabled = false; }
    }

    async function loadComps() {
        const { data } = await supabaseClient.from('companies').select('*');
        const sel = document.getElementById('company_id');
        data.forEach(c => { sel.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
    }
    loadComps();
</script>
</body>
</html>
