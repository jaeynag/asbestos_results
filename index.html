<div class="card">
    <div class="mode-switch">
        <div id="btn-nong" class="mode-btn active" onclick="setMode('ë†ë„')">ì„ë©´ ë†ë„</div>
        <div id="btn-bi" class="mode-btn" onclick="setMode('ë¹„ì‚°')">ë¹„ì‚° ëˆ„ì¶œ</div>
    </div>
    <label>ğŸ¢ ì†Œì† ì—…ì²´</label>
    <select id="company_id"></select>
    <label>ğŸ“ í˜„ì¥ëª… (ê°€ëª… ì…ë ¥ ê°€ëŠ¥)</label>
    <input type="text" id="site_name" placeholder="ì˜ˆ: ì„ì‹œ_Aë™, OOë¹Œë¼">
    <label>ğŸ‘· ì¸¡ì •ì</label>
    <input type="text" id="inspector_name" placeholder="ì„±í•¨ ì…ë ¥">
</div>

<div class="card">
    <h2 id="mode-title">ë†ë„ í¬ì¸íŠ¸ ì¸¡ì •</h2>
    
    <div id="nong-point-area">
        <label>ì¸¡ì • í¬ì¸íŠ¸ (ë²ˆí˜¸)</label>
        <input type="text" id="p_number" placeholder="ì˜ˆ: P1, P2 (ìˆ«ìë§Œ ì…ë ¥ë„ ê°€ëŠ¥)">
        <div class="p-btn" onclick="takePhoto('ë†ë„_ë‹¨ì¼')" style="margin-top:15px; height:100px;">
            <span id="txt-nong">ğŸ“· í¬ì¸íŠ¸ ì‚¬ì§„ ì´¬ì˜</span>
        </div>
    </div>

    <div id="bi-point-area" style="display:none;">
        <label>ë¹„ì‚° ì§€ì  ì„ íƒ</label>
        <select id="bi_point_name">
            <option value="ë¶€ì§€ê²½ê³„">ë¶€ì§€ê²½ê³„</option>
            <option value="ìœ„ìƒì„¤ë¹„">ìœ„ìƒì„¤ë¹„</option>
            <option value="ìŒì••ê¸°ë°°ì¶œêµ¬">ìŒì••ê¸° ë°°ì¶œêµ¬</option>
            <option value="íê¸°ë¬¼ë³´ê´€ì†Œ">íê¸°ë¬¼ ë³´ê´€ì†Œ</option>
        </select>
        <div class="photo-grid">
            <div class="p-btn" id="btn-before" onclick="takePhoto('ì „')">ğŸ“¸ ì‹œì‘ ì „</div>
            <div class="p-btn" id="btn-after" onclick="takePhoto('í›„')">ğŸ“¸ ì‘ì—… í›„</div>
        </div>
    </div>
</div>

<button class="submit-btn" onclick="uploadCurrentPoint()">ì´ í¬ì¸íŠ¸ ì „ì†¡</button>
<div id="status">ì „ì†¡ ëŒ€ê¸° ì¤‘...</div>

<script>
    // ... Supabase ì„¤ì • ...
    let currentMode = 'ë†ë„';
    let currentPhotoType = '';
    let tempFiles = {};

    function setMode(m) {
        currentMode = m;
        document.getElementById('btn-nong').className = m === 'ë†ë„' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('btn-bi').className = m === 'ë¹„ì‚°' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('nong-point-area').style.display = m === 'ë†ë„' ? 'block' : 'none';
        document.getElementById('bi-point-area').style.display = m === 'ë¹„ì‚°' ? 'block' : 'none';
        document.getElementById('mode-title').innerText = m === 'ë†ë„' ? 'ë†ë„ í¬ì¸íŠ¸ ì¸¡ì •' : 'ë¹„ì‚° í¬ì¸íŠ¸ ì¸¡ì •';
    }

    // ì‚¬ì§„ ì´¬ì˜ ë° ì„ì‹œ ì €ì¥ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ë˜ í”¼ë“œë°± ê°•í™”)
    function handleFile(input) {
        if(input.files[0]) {
            tempFiles[currentPhotoType] = input.files[0];
            alert(currentPhotoType + " ì‚¬ì§„ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    async function uploadCurrentPoint() {
        const site = document.getElementById('site_name').value;
        const comp = document.getElementById('company_id').value;
        if(!site) return alert("í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

        const status = document.getElementById('status');
        status.innerText = "â³ ë°ì´í„° ì „ì†¡ ì¤‘...";

        // 1. í”„ë¡œì íŠ¸ ìƒì„±/í™•ì¸
        const { data: pData } = await supabaseClient.from('projects').upsert([{
            company_id: comp, site_name: site, 
            inspector_name: document.getElementById('inspector_name').value,
            work_type: currentMode
        }], { onConflict: 'site_name' }).select();
        
        const pId = pData[0].id;

        // 2. ì‚¬ì§„ ì—…ë¡œë“œ ë° DB ê¸°ë¡
        for (let key in tempFiles) {
            let pointLabel = currentMode === 'ë†ë„' ? document.getElementById('p_number').value : document.getElementById('bi_point_name').value;
            let finalPhotoType = currentMode === 'ë†ë„' ? `${pointLabel}` : `${pointLabel}_${key}`;

            const fName = `${currentMode}/${site}/${finalPhotoType}_${Date.now()}.jpg`;
            const { data: sData } = await supabaseClient.storage.from('asbestos_photos').upload(fName, tempFiles[key]);

            await supabaseClient.from('project_photos').insert([{
                project_id: pId, photo_type: finalPhotoType, storage_path: sData.path
            }]);
        }

        status.innerText = "âœ… ì „ì†¡ ì™„ë£Œ! ë‹¤ìŒ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        // ì…ë ¥ ì´ˆê¸°í™” (í˜„ì¥ëª…ì€ ìœ ì§€)
        tempFiles = {};
        if(currentMode === 'ë†ë„') document.getElementById('p_number').value = "";
    }
</script>
