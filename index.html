<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŒ€í•œí™˜ê²½ í˜„ì¥ê´€ë¦¬ v6</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --bg: #F2F2F7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-size: 14px; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 80px; }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .card { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; }
        h2 { font-size: 15px; margin: 0 0 10px 0; color: #1c1c1e; border-left: 4px solid var(--primary); padding-left: 8px; }

        label { display: block; font-size: 11px; font-weight: 600; color: #8e8e93; margin-bottom: 2px; }
        input, select { 
            width: 100%; height: 40px; background: #F2F2F7; border: 1px solid #DDD; 
            border-radius: 6px; padding: 0 8px; outline: none;
        }

        /* ë‚ ì§œ ì…ë ¥ì°½ í¬ê¸° ìµœì í™” */
        .date-input { width: 160px; font-size: 16px; font-weight: bold; height: 45px; margin-bottom: 15px; }

        /* ì‹œë£Œ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ (ê°€ë¡œ í•œì¤„) */
        .input-row { display: grid; grid-template-columns: 1fr 1.2fr 60px; gap: 5px; margin-bottom: 8px; align-items: center; }
        .input-row-bi { display: grid; grid-template-columns: 1fr 1fr 45px 45px; gap: 4px; margin-bottom: 8px; align-items: center; }

        .tm-box { position: relative; }
        .tm-label { position: absolute; left: 5px; top: -8px; font-size: 9px; color: var(--primary); background: #fff; padding: 0 2px; }

        .cam-btn { 
            height: 40px; background: #E8F2FF; color: var(--primary); border: 1px solid var(--primary); 
            border-radius: 6px; font-weight: bold; font-size: 11px;
        }
        .cam-btn.done { background: var(--success) !important; border-color: #28a745 !important; color: white !important; }

        .tab-container { display: flex; background: #E5E5EA; border-radius: 8px; padding: 2px; margin-bottom: 10px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; color: #8E8E93; }
        .tab.active { background: white; color: var(--primary); }

        .btn-add { background: #555; color: white; border: none; width: 100%; height: 40px; border-radius: 8px; margin-top: 5px; }
        .btn-submit { position: fixed; bottom: 15px; left: 15px; right: 15px; height: 55px; background: var(--success); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="page1" class="page active">
    <div class="card">
        <h2>ğŸ—ï¸ í˜„ì¥ ì •ë³´</h2>
        <label>ğŸ¢ ì†Œì† ì—…ì²´</label>
        <select id="company_id" onchange="saveDraft()"></select>
        <label>ğŸ“ ê³µì‚¬ëª…</label>
        <input type="text" id="site_name" placeholder="í˜„ì¥ëª…" oninput="saveDraft()">
        <label>ğŸ‘· ì¸¡ì •ì</label>
        <input type="text" id="inspector_name" placeholder="ì„±í•¨" oninput="saveDraft()">
        <button class="btn-add" style="background:var(--primary); margin-top:15px;" onclick="goPage(2)">ë‹¤ìŒ ë‹¨ê³„ ã€‰</button>
    </div>
</div>

<div id="page2" class="page">
    <div class="tab-container">
        <div id="tab-nong" class="tab active" onclick="switchMode('ë†ë„')">ì„ë©´ ë†ë„</div>
        <div id="tab-bi" class="tab" onclick="switchMode('ë¹„ì‚°')">ë¹„ì‚° ì •ë„</div>
    </div>

    <div class="card">
        <label>ğŸ“… ì¸¡ì • ë‚ ì§œ</label>
        <input type="date" id="measure_date" class="date-input" onchange="saveDraft()">

        <div id="nong-section">
            <h2 style="margin-top:10px;">ì‹œë£Œ ëª©ë¡</h2>
            <div id="nong-list"></div>
            <button class="btn-add" onclick="addRow('ë†ë„')">+ ë†ë„ ì‹œë£Œ ì¶”ê°€</button>
        </div>

        <div id="bi-section" style="display:none;">
            <h2 style="margin-top:10px;">ì§€ì  ëª©ë¡</h2>
            <div id="bi-list"></div>
            <button class="btn-add" onclick="addRow('ë¹„ì‚°')">+ ë¹„ì‚° ì§€ì  ì¶”ê°€</button>
        </div>
    </div>

    <button class="btn-submit" id="btn-final" onclick="submitData()">ìµœì¢… ì „ì†¡ (ì™„ë£Œ)</button>
    <button onclick="goPage(1)" style="width:100%; background:none; border:none; color:#888; margin-top:15px;">ã€ˆ í˜„ì¥ì •ë³´ ìˆ˜ì •</button>
</div>

<input type="file" id="cam-input" accept="image/*" capture="camera" style="display:none;" onchange="handleFile(this)">

<script>
    const S_URL = "https://zaivmmhooaqaifbkulcl.supabase.co";
    const S_KEY = "sb_publishable_xiOg7viV4LgelbuxPLzw3g_YR1YQ4zi";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let mode = 'ë†ë„';
    let curTarget = null;
    let fileCache = {};

    // [í•µì‹¬] ë¡œì»¬ ë°ì´í„° ë³µêµ¬ ë° ì €ì¥
    function saveDraft() {
        const data = {
            site: document.getElementById('site_name').value,
            inspector: document.getElementById('inspector_name').value,
            comp: document.getElementById('company_id').value,
            date: document.getElementById('measure_date').value,
            mode: mode
        };
        localStorage.setItem('asbestos_draft', JSON.stringify(data));
    }

    function loadDraft() {
        const draft = JSON.parse(localStorage.getItem('asbestos_draft'));
        if(draft) {
            document.getElementById('site_name').value = draft.site || "";
            document.getElementById('inspector_name').value = draft.inspector || "";
            document.getElementById('company_id').value = draft.comp || "";
            document.getElementById('measure_date').value = draft.date || new Date().toISOString().substring(0, 10);
            if(draft.mode) switchMode(draft.mode);
        } else {
            document.getElementById('measure_date').value = new Date().toISOString().substring(0, 10);
        }
    }

    function goPage(n) {
        if(n===2 && !document.getElementById('site_name').value) return alert("í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('page'+n).classList.add('active');
        if(n===2 && mode==='ë†ë„' && document.getElementById('nong-list').children.length === 0) addRow('ë†ë„');
        if(n===2 && mode==='ë¹„ì‚°' && document.getElementById('bi-list').children.length === 0) addRow('ë¹„ì‚°');
    }

    function switchMode(m) {
        mode = m;
        document.getElementById('tab-nong').classList.toggle('active', m==='ë†ë„');
        document.getElementById('tab-bi').classList.toggle('active', m==='ë¹„ì‚°');
        document.getElementById('nong-section').style.display = m==='ë†ë„'?'block':'none';
        document.getElementById('bi-section').style.display = m==='ë¹„ì‚°'?'block':'none';
        saveDraft();
    }

    // ì‹œë£Œ ì¶”ê°€ ë¡œì§
    function addRow(type) {
        const id = Date.now();
        const container = type === 'ë†ë„' ? document.getElementById('nong-list') : document.getElementById('bi-list');
        const div = document.createElement('div');
        
        if(type === 'ë†ë„') {
            div.className = 'input-row';
            div.id = 'row-' + id;
            div.innerHTML = `
                <input type="text" class="loc" placeholder="ìœ„ì¹˜">
                <div class="tm-box"><span class="tm-label">ì‹œê°„</span><input type="time" class="tm"></div>
                <button class="cam-btn" onclick="openCam('${id}', 'photo')">ğŸ“· ì´¬ì˜</button>
            `;
        } else {
            div.className = 'input-row-bi';
            div.id = 'row-' + id;
            // ë¹„ì‚°ì€ ì´ì „ í–‰ì˜ ìœ„ì¹˜ëª…ì„ ì°¸ê³ í•˜ì—¬ ìë™ ìƒì„± (ë¶€ì§€ê²½ê³„1 -> ë¶€ì§€ê²½ê³„2)
            let prevLoc = "";
            const lastRow = container.lastElementChild;
            if(lastRow) prevLoc = lastRow.querySelector('.loc').value;
            
            let newLoc = prevLoc ? autoIncrement(prevLoc) : "ë¶€ì§€ê²½ê³„1";
            if(newLoc === "ë¶€ì§€ê²½ê³„1") newLoc = "ë¶€ì§€ê²½ê³„1"; // ì´ˆê¸°ê°’

            div.innerHTML = `
                <input type="text" class="loc" value="${newLoc}" oninput="syncTimeByLoc(this)">
                <div class="tm-box"><span class="tm-label">ì‹œê°„</span><input type="time" class="tm" oninput="syncTimeByLoc(this)"></div>
                <button class="cam-btn" id="btn-${id}-pre" onclick="openCam('${id}', 'pre')">ì „</button>
                <button class="cam-btn" id="btn-${id}-post" onclick="openCam('${id}', 'post')">í›„</button>
            `;
        }
        container.appendChild(div);
    }

    function autoIncrement(text) {
        return text.replace(/(\d+)$/, (match) => parseInt(match) + 1);
    }

    // [í•µì‹¬] ê°™ì€ ìœ„ì¹˜ ì´ë¦„ì´ë©´ ì‹œê°„ ë™ê¸°í™”
    function syncTimeByLoc(input) {
        const currentRow = input.closest('.input-row-bi') || input.closest('.input-row');
        const locName = currentRow.querySelector('.loc').value;
        const timeVal = currentRow.querySelector('.tm').value;

        document.querySelectorAll('.loc').forEach(el => {
            if(el.value === locName && el !== currentRow.querySelector('.loc')) {
                const targetRow = el.closest('.input-row-bi') || el.closest('.input-row');
                if(timeVal) targetRow.querySelector('.tm').value = timeVal;
            }
        });
    }

    function openCam(id, type) { curTarget = {id, type}; document.getElementById('cam-input').click(); }
    function handleFile(i) {
        if(i.files[0]) {
            fileCache[curTarget.id + curTarget.type] = i.files[0];
            const selector = curTarget.type === 'photo' ? `#row-${curTarget.id} .cam-btn` : `#btn-${curTarget.id}-${curTarget.type}`;
            const btn = document.querySelector(selector);
            btn.classList.add('done');
            btn.innerText = curTarget.type==='photo'?'âœ…':(curTarget.type==='pre'?'âœ…ì „':'âœ…í›„');
        }
    }

    async function submitData() {
        const btn = document.getElementById('btn-final');
        if(!confirm("ì„œë²„ë¡œ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        btn.disabled = true;
        btn.innerText = "â³ ì „ì†¡ ì¤‘...";

        try {
            const { data: pData } = await supabaseClient.from('projects').upsert([{
                company_id: document.getElementById('company_id').value,
                site_name: document.getElementById('site_name').value,
                inspector_name: document.getElementById('inspector_name').value,
                measure_date: document.getElementById('measure_date').value,
                work_type: mode
            }], { onConflict: 'site_name' }).select();

            const selector = mode === 'ë†ë„' ? '#nong-list .input-row' : '#bi-list .input-row-bi';
            const rows = document.querySelectorAll(selector);
            
            for(let row of rows) {
                const loc = row.querySelector('.loc').value;
                const tm = row.querySelector('.tm').value;
                const id = row.id.split('-')[1];
                const types = mode === 'ë†ë„' ? ['photo'] : ['pre', 'post'];

                for(let t of types) {
                    const file = fileCache[id + t];
                    if(!file) continue;
                    const path = `${mode}/${document.getElementById('site_name').value}/${loc}_${t}_${Date.now()}.jpg`;
                    await supabaseClient.storage.from('asbestos_photos').upload(path, file);
                    await supabaseClient.from('project_photos').insert([{
                        project_id: pData[0].id, photo_type: `${loc}_${t}`, storage_path: path, description: tm
                    }]);
                }
            }
            alert("ì „ì†¡ ì™„ë£Œ!");
            localStorage.removeItem('asbestos_draft');
            location.reload();
        } catch(e) { alert(e.message); btn.disabled = false; btn.innerText = "ì „ì†¡ ì‹¤íŒ¨ (ì¬ì‹œë„)"; }
    }

    async function loadComps() {
        const { data } = await supabaseClient.from('companies').select('*');
        const sel = document.getElementById('company_id');
        data.forEach(c => { sel.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        loadDraft();
    }
    loadComps();
</script>
</body>
</html>
