<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŒ€í•œí™˜ê²½ í˜„ì¥ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --bg: #F2F2F7; --card: #FFFFFF; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        .page { display: none; padding: 20px; min-height: 100vh; }
        .page.active { display: block; }
        
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2 { font-size: 1.1rem; margin-top: 0; color: #1c1c1e; border-left: 4px solid var(--primary); padding-left: 10px; }

        label { display: block; font-size: 13px; font-weight: 600; color: #8e8e93; margin-bottom: 5px; margin-top: 10px; }
        input, select { 
            width: 100%; height: 48px; background: #F2F2F7; border: 1px solid #DDD; 
            border-radius: 10px; padding: 0 12px; font-size: 16px; margin-bottom: 10px; outline: none;
        }

        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tab-container { display: flex; background: #E5E5EA; border-radius: 12px; padding: 3px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 12px; border-radius: 9px; font-weight: bold; font-size: 14px; cursor: pointer; color: #8E8E93; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* ì‹œë£Œ ë¦¬ìŠ¤íŠ¸ */
        .item-row { display: flex; align-items: center; justify-content: space-between; background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; }
        .item-info { flex: 1; }
        .item-info div { font-size: 15px; font-weight: 600; }
        .item-info span { font-size: 12px; color: var(--primary); font-weight: 500; }
        
        /* ì‚¬ì§„ ë²„íŠ¼ ìƒíƒœë³„ ë””ìì¸ */
        .cam-btn { 
            background: #E8F2FF; color: var(--primary); border: 2px solid var(--primary); 
            min-width: 65px; height: 45px; border-radius: 10px; font-weight: bold; 
            font-size: 13px; margin-left: 5px; transition: all 0.2s;
        }
        .cam-btn.done { 
            background: var(--success) !important; 
            border-color: #28a745 !important; 
            color: white !important; 
        }

        /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ */
        .nav-btn { width: 100%; height: 55px; border-radius: 14px; font-size: 17px; font-weight: bold; border: none; cursor: pointer; transition: 0.2s; }
        .btn-next { background: var(--primary); color: white; margin-top: 10px; }
        .btn-add { background: #555; color: white; margin-top: 5px; }
        .btn-next:active, .btn-add:active { opacity: 0.7; transform: scale(0.98); }
        .status-bar { text-align: center; font-size: 12px; color: #888; margin-top: 20px; padding-bottom: 30px; }
    </style>
</head>
<body>

<div id="page1" class="page active">
    <div class="card">
        <h2>ğŸ—ï¸ ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
        
        <label>ğŸ“… ì¸¡ì • ì¼ì</label>
        <input type="date" id="measure_date">

        <label>ğŸ¢ ì†Œì† ì—…ì²´</label>
        <select id="company_id"><option value="">ì—…ì²´ ë¡œë”© ì¤‘...</option></select>

        <label>ğŸ“ ê³µì‚¬ëª… (ê°€ëª… ê°€ëŠ¥)</label>
        <input type="text" id="site_name" placeholder="í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">

        <label>ğŸ‘· ì¸¡ì •ì</label>
        <input type="text" id="inspector_name" placeholder="ì„±í•¨ ì…ë ¥">
        
        <button class="nav-btn btn-next" onclick="goPage(2)">ë‹¤ìŒ ë‹¨ê³„ (ì‹œë£Œ ì¶”ê°€) ã€‰</button>
    </div>
</div>

<div id="page2" class="page">
    <div class="tab-container">
        <div id="tab-nong" class="tab active" onclick="switchMode('ë†ë„')">ì„ë©´ ë†ë„</div>
        <div id="tab-bi" class="tab" onclick="switchMode('ë¹„ì‚°')">ë¹„ì‚° ì •ë„</div>
    </div>

    <div class="card" id="input-area">
        <h2 id="mode-title">ë†ë„ ì‹œë£Œ ì¶”ê°€</h2>
        <label>ğŸ“ ì¸¡ì • ìœ„ì¹˜</label>
        <input type="text" id="loc_name" placeholder="ì˜ˆ: ê±°ì‹¤1, P1 ë“±">
        
        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>â° ì‹œì‘ ì‹œê°„</label>
                <input type="time" id="start_time">
            </div>
            <div style="flex: 1;">
                <label>â° ì¢…ë£Œ ì‹œê°„</label>
                <input type="time" id="end_time">
            </div>
        </div>

        <button class="nav-btn btn-add" onclick="addItem()">+ ëª©ë¡ì— ì‹œë£Œ ì¶”ê°€</button>
    </div>

    <div id="list-container">
        </div>

    <button class="nav-btn btn-next" id="btn-finish" onclick="finishAll()" style="background:#34C759; margin-top:30px;">ìµœì¢… ë°ì´í„° ì„œë²„ ì „ì†¡</button>
    <button class="nav-btn" onclick="goPage(1)" style="background:none; color:#888; font-size:14px; margin-top:10px;">ã€ˆ ì´ì „ ë‹¨ê³„ (ì •ë³´ ìˆ˜ì •)</button>
    <div id="status" class="status-bar">ì„œë²„ ì—°ê²°ë¨</div>
</div>

<input type="file" id="cam-input" accept="image/*" capture="camera" style="display:none;" onchange="handleFile(this)">

<script>
    const S_URL = "https://zaivmmhooaqaifbkulcl.supabase.co";
    const S_KEY = "sb_publishable_xiOg7viV4LgelbuxPLzw3g_YR1YQ4zi";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let mode = 'ë†ë„';
    let items = [];
    let currentCamTarget = null;

    // ì´ˆê¸° ì„¤ì •: ì˜¤ëŠ˜ ë‚ ì§œ ì„¸íŒ…
    document.getElementById('measure_date').value = new Date().toISOString().substring(0, 10);

    function goPage(num) {
        if(num === 2 && !document.getElementById('site_name').value) {
            alert("í˜„ì¥ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page' + num).classList.add('active');
        window.scrollTo(0,0);
    }

    function switchMode(m) {
        if(items.length > 0 && !confirm("ëª¨ë“œ ë³€ê²½ ì‹œ í˜„ì¬ ëª©ë¡ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        mode = m;
        items = [];
        renderList();
        document.getElementById('tab-nong').classList.toggle('active', m === 'ë†ë„');
        document.getElementById('tab-bi').classList.toggle('active', m === 'ë¹„ì‚°');
        document.getElementById('mode-title').innerText = m === 'ë†ë„' ? 'ë†ë„ ì‹œë£Œ ì¶”ê°€' : 'ë¹„ì‚° ì§€ì  ì¶”ê°€';
    }

    function addItem() {
        const loc = document.getElementById('loc_name').value;
        const start = document.getElementById('start_time').value;
        const end = document.getElementById('end_time').value;
        if(!loc) return alert("ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        items.push({
            id: Date.now(),
            location: loc,
            time: (start || end) ? `${start} ~ ${end}` : 'ì‹œê°„ ë¯¸ì…ë ¥',
            photo: null,
            photo_before: null,
            photo_after: null
        });
        renderList();
        document.getElementById('loc_name').value = "";
    }

    function renderList() {
        const container = document.getElementById('list-container');
        container.innerHTML = "";
        
        items.forEach(item => {
            const row = document.createElement('div');
            row.className = 'item-row';
            
            let photoBtns = "";
            if(mode === 'ë†ë„') {
                const btnText = item.photo ? "âœ… ì™„ë£Œ" : "ğŸ“· ì´¬ì˜";
                const btnClass = item.photo ? "cam-btn done" : "cam-btn";
                photoBtns = `<button class="${btnClass}" onclick="openCam(${item.id}, 'photo')">${btnText}</button>`;
            } else {
                const bText = item.photo_before ? "âœ… ì „" : "ì „";
                const bClass = item.photo_before ? "cam-btn done" : "cam-btn";
                const aText = item.photo_after ? "âœ… í›„" : "í›„";
                const aClass = item.photo_after ? "cam-btn done" : "cam-btn";
                photoBtns = `
                    <button class="${bClass}" onclick="openCam(${item.id}, 'photo_before')">${bText}</button>
                    <button class="${aClass}" onclick="openCam(${item.id}, 'photo_after')">${aText}</button>
                `;
            }

            row.innerHTML = `
                <div class="item-info">
                    <div>${item.location}</div>
                    <span>â° ${item.time}</span>
                </div>
                <div>${photoBtns}</div>
            `;
            container.appendChild(row);
        });
    }

    function openCam(id, type) {
        currentCamTarget = { id, type };
        document.getElementById('cam-input').click();
    }

    function handleFile(input) {
        if(input.files[0]) {
            const item = items.find(i => i.id === currentCamTarget.id);
            item[currentCamTarget.type] = input.files[0];
            renderList(); // ì¦‰ì‹œ ë¦¬ìŠ¤íŠ¸ ë¦¬ë Œë”ë§í•˜ì—¬ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        }
    }

    async function finishAll() {
        if(items.length === 0) return alert("ì „ì†¡í•  ì‹œë£Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        const btn = document.getElementById('btn-finish');
        const status = document.getElementById('status');
        
        btn.disabled = true;
        status.innerText = "â³ ì„œë²„ ì „ì†¡ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";

        try {
            // 1. í”„ë¡œì íŠ¸(í˜„ì¥) ì •ë³´ Upsert
            const { data: pData, error: pError } = await supabaseClient.from('projects').upsert([{
                company_id: document.getElementById('company_id').value,
                site_name: document.getElementById('site_name').value,
                inspector_name: document.getElementById('inspector_name').value,
                measure_date: document.getElementById('measure_date').value,
                work_type: mode
            }], { onConflict: 'site_name' }).select();

            if(pError) throw pError;
            const pId = pData[0].id;

            // 2. ê° ì‹œë£Œë³„ ì‚¬ì§„ ì—…ë¡œë“œ ë° ë°ì´í„° ê¸°ë¡
            for(let item of items) {
                const targets = mode === 'ë†ë„' ? ['photo'] : ['photo_before', 'photo_after'];
                for(let t of targets) {
                    if(!item[t]) continue;
                    
                    const fileName = `${mode}/${document.getElementById('site_name').value}/${item.location}_${t}_${Date.now()}.jpg`;
                    const { data: sData, error: sError } = await supabaseClient.storage.from('asbestos_photos').upload(fileName, item[t]);
                    
                    if(sError) throw sError;

                    await supabaseClient.from('project_photos').insert([{
                        project_id: pId,
                        photo_type: `${item.location}_${t}`,
                        storage_path: sData.path,
                        description: item.time // ì¸¡ì • ì‹œê°„ì„ ì‚¬ì§„ ì„¤ëª… ì»¬ëŸ¼ì— ì €ì¥
                    }]);
                }
            }
            alert("ì „ì†¡ ì™„ë£Œ! ëª¨ë“  ë°ì´í„°ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        } catch (e) {
            alert("ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            btn.disabled = false;
            status.innerText = "âŒ ì „ì†¡ ì‹¤íŒ¨ (ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”)";
        }
    }

    async function loadComps() {
        const { data, error } = await supabaseClient.from('companies').select('*');
        const sel = document.getElementById('company_id');
        if(error) {
            sel.innerHTML = `<option>ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</option>`;
            return;
        }
        sel.innerHTML = "";
        data.forEach(c => { sel.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
    }
    loadComps();
</script>
</body>
</html>
