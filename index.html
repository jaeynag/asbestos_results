<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŒ€í•œí™˜ê²½ í˜„ì¥ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ëª¨ë“  ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € í‘œì¤€ ìŠ¤íƒ€ì¼ */
        :root { --primary: #007AFF; --success: #34C759; --bg: #F2F2F7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 15px; line-height: 1.5; }
        
        .card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 16px; }
        h2 { font-size: 1.2rem; margin: 0 0 16px 0; color: #1c1c1e; text-align: center; }

        /* ëª¨ë“œ ì„ íƒ íƒ­ */
        .tab-container { display: flex; background: #e3e3e6; border-radius: 12px; padding: 4px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; border-radius: 9px; text-align: center; font-weight: bold; font-size: 15px; transition: 0.2s; cursor: pointer; color: #8e8e93; }
        .tab.active { background: #fff; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* ì…ë ¥ í¼ */
        label { display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 6px; }
        input, select { 
            width: 100%; height: 50px; background: #f9f9f9; border: 1px solid #ddd; 
            border-radius: 10px; padding: 0 15px; font-size: 16px; margin-bottom: 15px; outline: none;
        }
        input:focus { border-color: var(--primary); background: #fff; }

        /* ì‚¬ì§„ ì´¬ì˜ ì˜ì—­ */
        .photo-section { border: 2px dashed #ccc; border-radius: 12px; padding: 20px; text-align: center; background: #fafafa; cursor: pointer; transition: 0.3s; }
        .photo-section.has-file { border-color: var(--success); background: #f0fff4; }
        .photo-section i { font-size: 32px; display: block; margin-bottom: 8px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* í•˜ë‹¨ ì „ì†¡ ë²„íŠ¼ */
        .btn-submit { 
            width: 100%; height: 60px; background: var(--primary); color: #fff; border: none; 
            border-radius: 14px; font-size: 18px; font-weight: bold; margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0,122,255,0.3);
        }
        .btn-submit:active { transform: scale(0.98); opacity: 0.9; }
        
        #status-msg { text-align: center; font-size: 14px; margin-top: 12px; color: #007AFF; font-weight: 500; }
    </style>
</head>
<body>

<div class="card">
    <div class="tab-container">
        <div id="tab-nong" class="tab active" onclick="switchMode('ë†ë„')">ì„ë©´ ë†ë„</div>
        <div id="tab-bi" class="tab" onclick="switchMode('ë¹„ì‚°')">ë¹„ì‚° ëˆ„ì¶œ</div>
    </div>

    <label>ğŸ¢ ì—…ì²´ëª…</label>
    <select id="company_id"><option value="">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option></select>

    <label>ğŸ“ í˜„ì¥ëª… (ê°€ëª… ê°€ëŠ¥)</label>
    <input type="text" id="site_name" placeholder="í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">

    <label>ğŸ‘· ì¸¡ì •ì ì„±í•¨</label>
    <input type="text" id="inspector_name" placeholder="ì„±í•¨ ì…ë ¥">
</div>

<div id="section-nong" class="card">
    <h2>ğŸ“ ë†ë„ í¬ì¸íŠ¸ ì¸¡ì •</h2>
    <label>í¬ì¸íŠ¸ ë²ˆí˜¸ (ì˜ˆ: P1, P2)</label>
    <input type="text" id="p_number" placeholder="ë²ˆí˜¸ ì…ë ¥">
    
    <div class="photo-section" onclick="openCam('SINGLE')">
        <div id="preview-nong">ğŸ“· ì‚¬ì§„ ì´¬ì˜í•˜ê¸°</div>
    </div>
</div>

<div id="section-bi" class="card" style="display:none;">
    <h2>ğŸ“ ë¹„ì‚° ì§€ì  ì „/í›„ ì¸¡ì •</h2>
    <label>ì§€ì ëª… ì„ íƒ</label>
    <select id="bi_point_name">
        <option value="ë¶€ì§€ê²½ê³„">ë¶€ì§€ê²½ê³„</option>
        <option value="ìœ„ìƒì„¤ë¹„">ìœ„ìƒì„¤ë¹„</option>
        <option value="ìŒì••ê¸°ë°°ì¶œêµ¬">ìŒì••ê¸° ë°°ì¶œêµ¬</option>
        <option value="íê¸°ë¬¼ë³´ê´€ì†Œ">íê¸°ë¬¼ ë³´ê´€ì†Œ</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
    
    <div class="grid-2">
        <div class="photo-section" id="box-before" onclick="openCam('ì „')">
            <div id="txt-before">ğŸ“· ì‹œì‘ ì „</div>
        </div>
        <div class="photo-section" id="box-after" onclick="openCam('í›„')">
            <div id="txt-after">ğŸ“· ì¢…ë£Œ í›„</div>
        </div>
    </div>
</div>

<button class="btn-submit" onclick="handleUpload()">ì„œë²„ë¡œ ì „ì†¡í•˜ê¸°</button>
<div id="status-msg">ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ</div>

<input type="file" id="camera-input" accept="image/*" capture="camera" style="display:none;" onchange="fileSelected(this)">

<script>
    const S_URL = "https://zaivmmhooaqaifbkulcl.supabase.co";
    const S_KEY = "sb_publishable_xiOg7viV4LgelbuxPLzw3g_YR1YQ4zi";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let mode = 'ë†ë„';
    let targetSlot = '';
    let filesData = {};

    function switchMode(m) {
        mode = m;
        document.getElementById('tab-nong').classList.toggle('active', m === 'ë†ë„');
        document.getElementById('tab-bi').classList.toggle('active', m === 'ë¹„ì‚°');
        document.getElementById('section-nong').style.display = m === 'ë†ë„' ? 'block' : 'none';
        document.getElementById('section-bi').style.display = m === 'ë¹„ì‚°' ? 'block' : 'none';
        filesData = {}; // ëª¨ë“œ ë³€ê²½ ì‹œ ì´¬ì˜ ë°ì´í„° ì´ˆê¸°í™”
    }

    function openCam(slot) {
        targetSlot = slot;
        document.getElementById('camera-input').click();
    }

    function fileSelected(input) {
        if (input.files[0]) {
            filesData[targetSlot] = input.files[0];
            const displayId = targetSlot === 'SINGLE' ? 'preview-nong' : 'txt-' + (targetSlot === 'ì „' ? 'before' : 'after');
            const parentId = targetSlot === 'SINGLE' ? null : 'box-' + (targetSlot === 'ì „' ? 'before' : 'after');
            
            document.getElementById(displayId).innerText = "âœ… ì´¬ì˜ ì™„ë£Œ";
            if(parentId) document.getElementById(parentId).classList.add('has-file');
        }
    }

    async function handleUpload() {
        const site = document.getElementById('site_name').value;
        if (!site) return alert("í˜„ì¥ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        if (Object.keys(filesData).length === 0) return alert("ì‚¬ì§„ì„ ì´¬ì˜í•´ ì£¼ì„¸ìš”.");

        document.getElementById('status-msg').innerText = "â³ ì„œë²„ ì „ì†¡ ì¤‘...";

        try {
            // 1. í˜„ì¥ ì •ë³´ ì—…ë°ì´íŠ¸ (Upsert)
            const { data: pData } = await supabaseClient.from('projects').upsert([{
                company_id: document.getElementById('company_id').value,
                site_name: site,
                inspector_name: document.getElementById('inspector_name').value,
                work_type: mode
            }], { onConflict: 'site_name' }).select();

            const projectId = pData[0].id;

            // 2. í¬ì¸íŠ¸ ì‚¬ì§„ë³„ ì „ì†¡
            for (let key in filesData) {
                let pointName = mode === 'ë†ë„' ? document.getElementById('p_number').value : document.getElementById('bi_point_name').value;
                let photoTag = mode === 'ë†ë„' ? pointName : pointName + "_" + key;

                const path = `${mode}/${site}/${photoTag}_${Date.now()}.jpg`;
                const { data: stData } = await supabaseClient.storage.from('asbestos_photos').upload(path, filesData[key]);

                await supabaseClient.from('project_photos').insert([{
                    project_id: projectId,
                    photo_type: photoTag,
                    storage_path: stData.path
                }]);
            }

            alert("ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            // í¬ì¸íŠ¸ ë²ˆí˜¸ë§Œ ì´ˆê¸°í™”í•˜ì—¬ ë‹¤ìŒ í¬ì¸íŠ¸ ë°”ë¡œ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ í•¨
            if(mode === 'ë†ë„') document.getElementById('p_number').value = "";
            filesData = {};
            document.getElementById('status-msg').innerText = "âœ… ì „ì†¡ ì™„ë£Œ! ë‹¤ìŒ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        } catch (e) {
            alert("ì „ì†¡ ì˜¤ë¥˜: " + e.message);
            document.getElementById('status-msg').innerText = "âŒ ì „ì†¡ ì‹¤íŒ¨";
        }
    }

    async function loadComps() {
        const { data } = await supabaseClient.from('companies').select('*');
        const sel = document.getElementById('company_id');
        sel.innerHTML = '';
        data.forEach(c => { sel.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
    }
    loadComps();
</script>

</body>
</html>
