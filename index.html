<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì„ë©´í˜„ì¥ê´€ë¦¬ SaaS v8</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --bg: #F2F2F7; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); margin: 0; padding: 0; padding-bottom: 90px; }

        /* Login & Selector View */
        .auth-overlay { position: fixed; inset: 0; background: #fff; z-index: 1000; padding: 40px 20px; display: flex; flex-direction: column; }
        .comp-card { background: #f9f9f9; border: 2px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .comp-card.active { border-color: var(--primary); background: #f0f7ff; }

        /* Main UI */
        .header { background: #fff; padding: 15px; border-bottom: 1px solid #ddd; sticky: top; }
        .card { background: #fff; margin: 10px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .grid-row { display: grid; grid-template-columns: 1fr 70px 60px; gap: 8px; margin-bottom: 10px; align-items: end; }
        
        input, select { width: 100%; height: 44px; border-radius: 8px; border: 1px solid #ddd; padding: 0 10px; background: #fdfdfd; font-size: 15px; }
        .btn-cam { height: 44px; background: #fff; border: 2px solid var(--primary); color: var(--primary); border-radius: 8px; font-weight: bold; font-size: 12px; }
        .btn-cam.done { background: var(--success); color: #fff; border-color: var(--success); }
        
        /* History & Grouping */
        .date-badge { background: #333; color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 12px; display: inline-block; margin: 15px 0 5px 10px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: #fff; }

        .footer { position: fixed; bottom: 0; width: 100%; padding: 15px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .btn-main { width: 100%; height: 55px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-size: 17px; font-weight: bold; }
    </style>
</head>
<body>

<div id="auth-view" class="auth-overlay">
    <h1 style="font-size: 24px; margin-bottom: 5px;">ë°˜ê°‘ìŠµë‹ˆë‹¤!</h1>
    <p style="color: #666; margin-bottom: 30px;">ì ‘ì†í•˜ì‹¤ íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
    <div id="company-list">
        </div>
    <button class="btn-main" style="margin-top:auto" onclick="startWork()">í˜„ì¥ ì—…ë¬´ ì‹œì‘</button>
</div>

<div id="main-view" style="display:none">
    <div class="header">
        <span id="display-comp" style="font-weight: bold; color: var(--primary);">íšŒì‚¬ëª…</span>
        <span style="color:#ccc; margin:0 5px;">|</span>
        <span id="display-user">ì¸¡ì •ì</span>
    </div>

    <div class="card">
        <label style="font-size:12px; color:#888;">ğŸ“… ì¸¡ì • ë‚ ì§œ</label>
        <input type="date" id="m_date" style="border:none; font-size:20px; font-weight:bold; padding:0; height:auto; margin-bottom:15px;">
        
        <label style="font-size:12px; color:#888;">ğŸ“ í˜„ì¥(ê³µì‚¬)ëª…</label>
        <input type="text" id="site_name" placeholder="ê°€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="margin-bottom:15px;">

        <div id="input-grid" class="grid-row">
            <div><label>ìœ„ì¹˜</label><input type="text" id="loc" placeholder="P1"></div>
            <div><label>ì‹œê°„</label><input type="time" id="tm"></div>
            <button class="btn-cam" id="btn-cam" onclick="triggerCam()">ğŸ“· ì´¬ì˜</button>
        </div>
        <button class="btn-main" style="height:44px; background:#444; font-size:15px;" onclick="registerItem()">ì‹œë£Œ ë“±ë¡</button>
    </div>

    <div id="history-container"></div>

    <div class="footer">
        <button class="btn-main" style="background:var(--success)" onclick="uploadAll()">ì‚¬ë¬´ì‹¤ë¡œ ë°ì´í„° ì „ì†¡ (ë™ê¸°í™”)</button>
    </div>
</div>

<input type="file" id="cam-input" accept="image/*" capture="camera" style="display:none;" onchange="handleFile(this)">

<script>
    const S_URL = "https://zaivmmhooaqaifbkulcl.supabase.co";
    const S_KEY = "sb_publishable_xiOg7viV4LgelbuxPLzw3g_YR1YQ4zi";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let selectedComp = null;
    let dataList = [];
    let curFile = null;

    // 1. ì´ˆê¸° íšŒì‚¬ ëª©ë¡ ë¡œë“œ (ë¡œê·¸ì¸ í›„ ì†Œì†ëœ íšŒì‚¬ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ë¡œì§)
    async function loadInitial() {
        const { data } = await supabaseClient.from('companies').select('*');
        const list = document.getElementById('company-list');
        data.forEach(c => {
            const div = document.createElement('div');
            div.className = 'comp-card';
            div.innerHTML = `<b>${c.name}</b><br><small>${c.business_no || 'ì‚¬ì—…ìë²ˆí˜¸ ì—†ìŒ'}</small>`;
            div.onclick = () => {
                document.querySelectorAll('.comp-card').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
                selectedComp = c;
            };
            list.appendChild(div);
        });
        document.getElementById('m_date').value = new Date().toISOString().substring(0, 10);
    }

    function startWork() {
        if(!selectedComp) return alert("íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        document.getElementById('auth-view').style.display = 'none';
        document.getElementById('main-view').style.display = 'block';
        document.getElementById('display-comp').innerText = selectedComp.name;
        document.getElementById('display-user').innerText = "ê´€ë¦¬ì"; // ë¡œê·¸ì¸ ì—°ë™ ì‹œ ì‚¬ìš©ì ì´ë¦„
    }

    function triggerCam() { document.getElementById('cam-input').click(); }
    function handleFile(i) {
        if(i.files[0]) {
            curFile = i.files[0];
            document.getElementById('btn-cam').classList.add('done');
            document.getElementById('btn-cam').innerText = "âœ… ì™„ë£Œ";
        }
    }

    function registerItem() {
        const date = document.getElementById('m_date').value;
        const site = document.getElementById('site_name').value;
        const loc = document.getElementById('loc').value;
        const tm = document.getElementById('tm').value;

        if(!site || !loc) return alert("í˜„ì¥ëª…ê³¼ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.");

        dataList.push({ id: Date.now(), date, site, loc, tm, file: curFile });
        renderHistory();
        
        // ë‹¤ìŒ ì…ë ¥ ìë™ ì¤€ë¹„
        document.getElementById('loc').value = loc.replace(/(\d+)$/, (m) => parseInt(m) + 1);
        document.getElementById('btn-cam').classList.remove('done');
        document.getElementById('btn-cam').innerText = "ğŸ“· ì´¬ì˜";
        curFile = null;
    }

    function renderHistory() {
        const container = document.getElementById('history-container');
        container.innerHTML = "";
        const dates = [...new Set(dataList.map(d => d.date))].sort().reverse();

        dates.forEach(d => {
            container.innerHTML += `<span class="date-badge">${d}</span>`;
            dataList.filter(i => i.date === d).forEach(item => {
                container.innerHTML += `
                    <div class="history-item">
                        <div><b>${item.loc}</b> <small style="color:#888; margin-left:8px;">${item.tm}</small><br>
                        <span style="font-size:11px; color:var(--primary)">${item.site}</span></div>
                        <button style="border:none; background:none; color:#FF3B30;" onclick="removeItem(${item.id})">ì‚­ì œ</button>
                    </div>`;
            });
        });
    }

    function removeItem(id) {
        dataList = dataList.filter(i => i.id !== id);
        renderHistory();
    }

    async function uploadAll() {
        if(dataList.length === 0) return alert("ì „ì†¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const btn = document.querySelector('.btn-main[onclick="uploadAll()"]');
        btn.disabled = true; btn.innerText = "â³ ë™ê¸°í™” ì¤‘...";

        try {
            for(let item of dataList) {
                // 1. í”„ë¡œì íŠ¸(í˜„ì¥) ìƒì„±/ì—…ë°ì´íŠ¸
                const { data: pData } = await supabaseClient.from('projects').upsert([{
                    company_id: selectedComp.id, site_name: item.site, measure_date: item.date
                }], { onConflict: 'site_name' }).select();

                // 2. ì‚¬ì§„ ì—…ë¡œë“œ ë° ì •ë³´ ê¸°ë¡
                if(item.file) {
                    const path = `sync/${selectedComp.id}/${item.site}/${item.loc}_${Date.now()}.jpg`;
                    await supabaseClient.storage.from('asbestos_photos').upload(path, item.file);
                    await supabaseClient.from('project_photos').insert([{
                        project_id: pData[0].id, photo_type: item.loc, storage_path: path, description: item.tm
                    }]);
                }
            }
            alert("ë™ê¸°í™” ì™„ë£Œ! PC í”„ë¡œê·¸ë¨ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            dataList = []; renderHistory();
        } catch(e) { alert(e.message); } finally { btn.disabled = false; btn.innerText = "ì‚¬ë¬´ì‹¤ë¡œ ë°ì´í„° ì „ì†¡ (ë™ê¸°í™”)"; }
    }

    loadInitial();
</script>
</body>
</html>
