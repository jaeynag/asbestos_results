<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŒ€í•œí™˜ê²½ í˜„ì¥ê´€ë¦¬ v7</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --bg: #F2F2F7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-size: 14px; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 100px; }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .card { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; }
        h2 { font-size: 15px; margin: 0 0 10px 0; color: #1c1c1e; border-left: 4px solid var(--primary); padding-left: 8px; }

        input, select { width: 100%; height: 40px; background: #F2F2F7; border: 1px solid #DDD; border-radius: 6px; padding: 0 8px; outline: none; }
        .date-input { width: 150px; font-weight: bold; margin-bottom: 10px; }

        /* ì…ë ¥ ì˜ì—­ ê·¸ë¦¬ë“œ - ì‹œê°„ ì¹¸ ì¶•ì†Œ */
        .input-grid { display: grid; grid-template-columns: 1fr 80px 70px; gap: 5px; align-items: end; }
        .input-grid-bi { display: grid; grid-template-columns: 1fr 80px 45px 45px; gap: 4px; align-items: end; }

        .cam-btn { height: 40px; background: #E8F2FF; color: var(--primary); border: 1px solid var(--primary); border-radius: 6px; font-weight: bold; font-size: 11px; }
        .cam-btn.done { background: var(--success) !important; border-color: #28a745 !important; color: white !important; }

        /* ë“±ë¡ëœ ì‹œë£Œ ìŠ¤íƒ€ì¼ */
        .date-group { margin-top: 15px; }
        .date-header { font-weight: bold; color: #555; margin: 10px 0 5px 5px; display: block; }
        .item-row { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 10px; border-bottom: 1px solid #eee; }
        .item-row:last-child { border: none; }
        .item-info { flex: 1; }
        .item-info b { font-size: 14px; }
        .item-info span { font-size: 11px; color: #888; margin-left: 5px; }
        
        .btn-del { color: var(--danger); border: none; background: none; font-weight: bold; padding: 5px; margin-left: 10px; }
        .btn-reg { background: #555; color: white; border: none; width: 100%; height: 45px; border-radius: 8px; margin-top: 10px; font-weight: bold; }
        .btn-submit { position: fixed; bottom: 15px; left: 15px; right: 15px; height: 55px; background: var(--success); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; z-index: 100; }

        .tab-container { display: flex; background: #E5E5EA; border-radius: 8px; padding: 2px; margin-bottom: 10px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; color: #8E8E93; }
        .tab.active { background: white; color: var(--primary); }
    </style>
</head>
<body>

<div id="page1" class="page active">
    <div class="card">
        <h2>ğŸ—ï¸ í˜„ì¥ ì •ë³´</h2>
        <input type="text" id="site_name" placeholder="í˜„ì¥ëª…" style="margin-bottom:10px;">
        <input type="text" id="inspector_name" placeholder="ì¸¡ì •ì ì„±í•¨">
        <button class="btn-reg" style="background:var(--primary);" onclick="goPage(2)">ë‹¤ìŒ ë‹¨ê³„ ã€‰</button>
    </div>
</div>

<div id="page2" class="page">
    <div class="tab-container">
        <div id="tab-nong" class="tab active" onclick="switchMode('ë†ë„')">ì„ë©´ ë†ë„</div>
        <div id="tab-bi" class="tab" onclick="switchMode('ë¹„ì‚°')">ë¹„ì‚° ì •ë„</div>
    </div>

    <div class="card">
        <input type="date" id="measure_date" class="date-input">
        
        <div id="input-area-nong" class="input-grid">
            <div><label>ìœ„ì¹˜</label><input type="text" id="loc_n"></div>
            <div><label>ì‹œê°„</label><input type="time" id="time_n"></div>
            <button class="cam-btn" id="btn-cam-n" onclick="openCam('single')">ğŸ“· ì´¬ì˜</button>
        </div>

        <div id="input-area-bi" class="input-grid-bi" style="display:none;">
            <div><label>ìœ„ì¹˜</label><input type="text" id="loc_b"></div>
            <div><label>ì‹œê°„</label><input type="time" id="time_b"></div>
            <button class="cam-btn" id="btn-cam-b1" onclick="openCam('pre')">ì „</button>
            <button class="cam-btn" id="btn-cam-b2" onclick="openCam('post')">í›„</button>
        </div>

        <button class="btn-reg" onclick="registerItem()">ì‹œë£Œ ë“±ë¡</button>
    </div>

    <div id="history-container"></div>

    <button class="btn-submit" onclick="submitToSupabase()">ìµœì¢… ì „ì†¡ (ì„œë²„ ì—…ë¡œë“œ)</button>
</div>

<input type="file" id="cam-input" accept="image/*" capture="camera" style="display:none;" onchange="handleFile(this)">

<script>
    const S_URL = "https://zaivmmhooaqaifbkulcl.supabase.co";
    const S_KEY = "sb_publishable_xiOg7viV4LgelbuxPLzw3g_YR1YQ4zi";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let mode = 'ë†ë„';
    let items = []; // ë“±ë¡ëœ ëª¨ë“  ì‹œë£Œ ë°ì´í„°
    let tempPhotos = {}; // í˜„ì¬ ì´¬ì˜ ì¤‘ì¸ ì‚¬ì§„ ì„ì‹œ ë³´ê´€
    let curCamType = '';

    document.getElementById('measure_date').value = new Date().toISOString().substring(0, 10);

    function goPage(n) {
        if(!document.getElementById('site_name').value) return alert("í˜„ì¥ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('page'+n).classList.add('active');
    }

    function switchMode(m) {
        mode = m;
        document.getElementById('tab-nong').classList.toggle('active', m==='ë†ë„');
        document.getElementById('tab-bi').classList.toggle('active', m==='ë¹„ì‚°');
        document.getElementById('input-area-nong').style.display = m==='ë†ë„'?'grid':'none';
        document.getElementById('input-area-bi').style.display = m==='ë¹„ì‚°'?'grid':'none';
    }

    // ì‚¬ì§„ ì´¬ì˜
    function openCam(type) {
        curCamType = type;
        document.getElementById('cam-input').click();
    }

    function handleFile(i) {
        if(i.files[0]) {
            tempPhotos[curCamType] = i.files[0];
            const btnId = curCamType === 'single' ? 'btn-cam-n' : (curCamType === 'pre' ? 'btn-cam-b1' : 'btn-cam-b2');
            document.getElementById(btnId).classList.add('done');
            document.getElementById(btnId).innerText = "âœ…";
        }
    }

    // ì‹œë£Œ ë“±ë¡ (ë¦¬ìŠ¤íŠ¸ë¡œ ì¶”ê°€)
    function registerItem() {
        const date = document.getElementById('measure_date').value;
        const loc = mode === 'ë†ë„' ? document.getElementById('loc_n').value : document.getElementById('loc_b').value;
        const time = mode === 'ë†ë„' ? document.getElementById('time_n').value : document.getElementById('time_b').value;

        if(!loc) return alert("ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const newItem = {
            id: Date.now(),
            date: date,
            mode: mode,
            loc: loc,
            time: time,
            photos: {...tempPhotos}
        };

        items.push(newItem);
        renderHistory();
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        if(mode==='ë†ë„') {
            document.getElementById('loc_n').value = autoIncrement(loc);
            document.getElementById('btn-cam-n').classList.remove('done');
            document.getElementById('btn-cam-n').innerText = "ğŸ“· ì´¬ì˜";
        } else {
            document.getElementById('loc_b').value = autoIncrement(loc);
            ['btn-cam-b1', 'btn-cam-b2'].forEach(id => {
                document.getElementById(id).classList.remove('done');
                document.getElementById(id).innerText = (id==='btn-cam-b1'?'ì „':'í›„');
            });
        }
        tempPhotos = {};
    }

    function autoIncrement(text) {
        return text.replace(/(\d+)$/, (m) => parseInt(m) + 1);
    }

    // ë‚ ì§œë³„ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderHistory() {
        const container = document.getElementById('history-container');
        container.innerHTML = "";

        // ë‚ ì§œìˆœ ì •ë ¬
        const sortedDates = [...new Set(items.map(i => i.date))].sort().reverse();

        sortedDates.forEach(date => {
            const dateGroup = document.createElement('div');
            dateGroup.className = 'date-group';
            dateGroup.innerHTML = `<span class="date-header">${date}</span>`;
            
            const card = document.createElement('div');
            card.className = 'card';
            card.style.padding = "0";

            items.filter(i => i.date === date).forEach(item => {
                const row = document.createElement('div');
                row.className = 'item-row';
                const hasPhoto = Object.keys(item.photos).length > 0 ? "âœ…ì‚¬ì§„" : "âŒë¬´ì œ";
                row.innerHTML = `
                    <div class="item-info" onclick="editItem(${item.id})">
                        <b>${item.loc}</b> <span>${item.time}</span> <small style="color:var(--primary)">(${hasPhoto})</small>
                    </div>
                    <button class="btn-del" onclick="deleteItem(${item.id})">ì‚­ì œ</button>
                `;
                card.appendChild(row);
            });
            dateGroup.appendChild(card);
            container.appendChild(dateGroup);
        });
    }

    function deleteItem(id) {
        if(confirm("ì´ ì‹œë£Œë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
            items = items.filter(i => i.id !== id);
            renderHistory();
        }
    }

    function editItem(id) {
        const item = items.find(i => i.id === id);
        if(!item) return;
        document.getElementById('measure_date').value = item.date;
        switchMode(item.mode);
        if(item.mode === 'ë†ë„') {
            document.getElementById('loc_n').value = item.loc;
            document.getElementById('time_n').value = item.time;
        } else {
            document.getElementById('loc_b').value = item.loc;
            document.getElementById('time_b').value = item.time;
        }
        // ìˆ˜ì • ì‹œ ê¸°ì¡´ í•­ëª© ì‚­ì œ í›„ ë‹¤ì‹œ ë“±ë¡í•˜ëŠ” ë°©ì‹
        items = items.filter(i => i.id !== id);
        renderHistory();
        window.scrollTo(0,0);
    }

    async function submitToSupabase() {
        if(items.length === 0) return alert("ì „ì†¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        if(!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const site = document.getElementById('site_name').value;
        const inspector = document.getElementById('inspector_name').value;

        try {
            // í”„ë¡œì íŠ¸ ìƒì„±
            const { data: pData } = await supabaseClient.from('projects').upsert([{
                site_name: site, inspector_name: inspector
            }], { onConflict: 'site_name' }).select();

            for(let item of items) {
                for(let key in item.photos) {
                    const path = `${item.mode}/${site}/${item.date}_${item.loc}_${key}.jpg`;
                    await supabaseClient.storage.from('asbestos_photos').upload(path, item.photos[key]);
                    await supabaseClient.from('project_photos').insert([{
                        project_id: pData[0].id,
                        photo_type: `${item.loc}_${key}`,
                        storage_path: path,
                        description: `${item.date} ${item.time}`
                    }]);
                }
            }
            alert("ì„œë²„ ì „ì†¡ ì™„ë£Œ!");
            items = []; renderHistory();
        } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
    }
</script>
</body>
</html>
