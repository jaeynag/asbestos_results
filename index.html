<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŒ€í•œí™˜ê²½ í˜„ì¥ê´€ë¦¬ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --bg: #F2F2F7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 12px; padding-bottom: 100px; color: #1c1c1e; }
        
        /* Typography & Layout */
        h2 { font-size: 16px; margin: 0 0 12px 0; display: flex; align-items: center; gap: 6px; }
        .card { background: #fff; border-radius: 14px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); margin-bottom: 12px; }
        
        /* Input Design */
        label { display: block; font-size: 11px; font-weight: 600; color: #8e8e93; margin-bottom: 4px; }
        input { width: 100%; height: 42px; background: #F2F2F7; border: 1px solid #E5E5EA; border-radius: 8px; padding: 0 10px; font-size: 15px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); background: #fff; }
        
        .date-input { width: 100%; max-width: 180px; font-size: 17px; font-weight: bold; border: 2px solid var(--primary); margin-bottom: 15px; }

        /* Grid System for Rows */
        .grid-nong { display: grid; grid-template-columns: 1fr 75px 65px; gap: 8px; }
        .grid-bi { display: grid; grid-template-columns: 1fr 75px 45px 45px; gap: 6px; }

        /* Buttons */
        .btn-cam { height: 42px; background: #fff; color: var(--primary); border: 1.5px solid var(--primary); border-radius: 8px; font-weight: 700; font-size: 12px; }
        .btn-cam.done { background: var(--success); color: #fff; border-color: var(--success); }
        .btn-reg { width: 100%; height: 48px; background: #333; color: #fff; border: none; border-radius: 10px; font-weight: bold; margin-top: 12px; }
        .btn-del { color: var(--danger); border: none; background: rgba(255,59,48,0.1); padding: 6px 10px; border-radius: 6px; font-size: 12px; }

        /* History List */
        .history-date { font-weight: 800; font-size: 18px; margin: 20px 0 10px 5px; color: #333; }
        .item-card { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #F2F2F7; }
        .item-card:last-child { border: none; }
        .item-info { flex: 1; }
        .item-info b { font-size: 15px; color: #000; }
        .item-info span { font-size: 12px; color: var(--primary); margin-left: 8px; font-weight: 600; }
        
        /* Fixed Submit Footer */
        .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; background: rgba(242,242,247,0.8); backdrop-filter: blur(10px); }
        .btn-submit { width: 100%; height: 55px; background: var(--success); color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: 800; box-shadow: 0 5px 15px rgba(52,199,89,0.3); }

        .tab-nav { display: flex; background: #E5E5EA; border-radius: 10px; padding: 3px; margin-bottom: 15px; }
        .tab-item { flex: 1; text-align: center; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; color: #8E8E93; }
        .tab-item.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="page1" class="page active">
    <div class="card" style="margin-top: 50px;">
        <h2 style="font-size: 22px;">ğŸ¢ í˜„ì¥ ì •ë³´ ì…ë ¥</h2>
        <div style="margin-bottom:15px;">
            <label>ê³µì‚¬ëª…</label>
            <input type="text" id="site_name" placeholder="í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div>
            <label>ì¸¡ì •ì</label>
            <input type="text" id="inspector_name" placeholder="ì„±í•¨">
        </div>
        <button class="btn-reg" style="background:var(--primary); height: 55px; font-size: 17px;" onclick="goPage(2)">ì…ë ¥ ì‹œì‘í•˜ê¸°</button>
    </div>
</div>

<div id="page2" class="page">
    <div class="tab-nav">
        <div id="t-nong" class="tab-item active" onclick="setMode('ë†ë„')">ì„ë©´ ë†ë„</div>
        <div id="t-bi" class="tab-item" onclick="setMode('ë¹„ì‚°')">ë¹„ì‚° ì •ë„</div>
    </div>

    <div class="card">
        <label>ğŸ“… ì¸¡ì • ë‚ ì§œ ì„ íƒ</label>
        <input type="date" id="measure_date" class="date-input">

        <div id="area-nong" class="grid-nong">
            <div><label>ì¸¡ì • ìœ„ì¹˜</label><input type="text" id="loc_n" placeholder="P1"></div>
            <div><label>ì‹œê°„</label><input type="time" id="time_n"></div>
            <button class="btn-cam" id="cam-n" onclick="takePic('single')">ğŸ“· ì´¬ì˜</button>
        </div>

        <div id="area-bi" class="grid-bi" style="display:none;">
            <div><label>ì¸¡ì • ìœ„ì¹˜</label><input type="text" id="loc_b" placeholder="ë¶€ì§€ê²½ê³„1"></div>
            <div><label>ì‹œê°„</label><input type="time" id="time_b"></div>
            <button class="btn-cam" id="cam-b1" onclick="takePic('pre')">ì „</button>
            <button class="btn-cam" id="cam-b2" onclick="takePic('post')">í›„</button>
        </div>

        <button class="btn-reg" onclick="pushItem()">ì‹œë£Œ ë“±ë¡</button>
    </div>

    <div id="history-list"></div>

    <div class="footer">
        <button class="btn-submit" onclick="finalUpload()">ì„œë²„ë¡œ ìµœì¢… ì „ì†¡</button>
    </div>
</div>

<input type="file" id="cam-input" accept="image/*" capture="camera" style="display:none;" onchange="onFileSelected(this)">

<script>
    const S_URL = "https://zaivmmhooaqaifbkulcl.supabase.co";
    const S_KEY = "sb_publishable_xiOg7viV4LgelbuxPLzw3g_YR1YQ4zi";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let mode = 'ë†ë„';
    let dataStore = []; 
    let tempFile = {};
    let activeCam = '';

    document.getElementById('measure_date').value = new Date().toISOString().substring(0, 10);

    function goPage(n) {
        if(!document.getElementById('site_name').value) return alert("í˜„ì¥ëª…ì„ ì ì–´ì£¼ì„¸ìš”.");
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page'+n).classList.add('active');
    }

    function setMode(m) {
        mode = m;
        document.getElementById('t-nong').classList.toggle('active', m==='ë†ë„');
        document.getElementById('t-bi').classList.toggle('active', m==='ë¹„ì‚°');
        document.getElementById('area-nong').style.display = m==='ë†ë„'?'grid':'none';
        document.getElementById('area-bi').style.display = m==='ë¹„ì‚°'?'grid':'none';
    }

    function takePic(type) { activeCam = type; document.getElementById('cam-input').click(); }

    function onFileSelected(input) {
        if(input.files[0]) {
            tempFile[activeCam] = input.files[0];
            const target = activeCam === 'single' ? 'cam-n' : (activeCam==='pre'?'cam-b1':'cam-b2');
            const btn = document.getElementById(target);
            btn.classList.add('done');
            btn.innerText = "âœ…";
        }
    }

    function pushItem() {
        const date = document.getElementById('measure_date').value;
        const loc = mode === 'ë†ë„' ? document.getElementById('loc_n').value : document.getElementById('loc_b').value;
        const time = mode === 'ë†ë„' ? document.getElementById('time_n').value : document.getElementById('time_b').value;

        if(!loc) return alert("ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        // ê°™ì€ ì´ë¦„ì´ë©´ ì‹œê°„ ë™ê¸°í™” ë¡œì§
        dataStore.filter(i => i.loc === loc).forEach(i => i.time = time);

        dataStore.push({
            id: Date.now(),
            date, mode, loc, time,
            files: {...tempFile}
        });

        renderList();
        resetInput(loc);
    }

    function resetInput(prevLoc) {
        const nextLoc = prevLoc.replace(/(\d+)$/, (m) => parseInt(m) + 1);
        if(mode==='ë†ë„') {
            document.getElementById('loc_n').value = nextLoc;
            document.getElementById('cam-n').classList.remove('done');
            document.getElementById('cam-n').innerText = "ğŸ“· ì´¬ì˜";
        } else {
            document.getElementById('loc_b').value = nextLoc;
            document.getElementById('cam-b1').classList.remove('done');
            document.getElementById('cam-b2').classList.remove('done');
            document.getElementById('cam-b1').innerText = "ì „";
            document.getElementById('cam-b2').innerText = "í›„";
        }
        tempFile = {};
    }

    function renderList() {
        const container = document.getElementById('history-list');
        container.innerHTML = "";
        
        const dates = [...new Set(dataStore.map(d => d.date))].sort().reverse();

        dates.forEach(date => {
            const dateDiv = document.createElement('div');
            dateDiv.innerHTML = `<div class="history-date">${date}</div>`;
            const card = document.createElement('div');
            card.className = 'card';

            dataStore.filter(i => i.date === date).forEach(item => {
                const row = document.createElement('div');
                row.className = 'item-card';
                const photoInfo = Object.keys(item.files).length > 0 ? "ğŸ“¸ OK" : "âšª NO";
                row.innerHTML = `
                    <div class="item-info" onclick="editItem(${item.id})">
                        <b>${item.loc}</b><span>${item.time}</span> <small style="margin-left:10px; color:#888;">${photoInfo}</small>
                    </div>
                    <button class="btn-del" onclick="removeItem(${item.id})">ì‚­ì œ</button>
                `;
                card.appendChild(row);
            });
            dateDiv.appendChild(card);
            container.appendChild(dateDiv);
        });
    }

    function removeItem(id) {
        if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            dataStore = dataStore.filter(i => i.id !== id);
            renderList();
        }
    }

    function editItem(id) {
        const item = dataStore.find(i => i.id === id);
        document.getElementById('measure_date').value = item.date;
        setMode(item.mode);
        if(item.mode === 'ë†ë„') {
            document.getElementById('loc_n').value = item.loc;
            document.getElementById('time_n').value = item.time;
        } else {
            document.getElementById('loc_b').value = item.loc;
            document.getElementById('time_b').value = item.time;
        }
        dataStore = dataStore.filter(i => i.id !== id);
        renderList();
        window.scrollTo(0,0);
    }

    async function finalUpload() {
        if(dataStore.length === 0) return alert("ë“±ë¡ëœ ì‹œë£Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        const btn = document.querySelector('.btn-submit');
        btn.disabled = true;
        btn.innerText = "â³ ì „ì†¡ ì¤‘...";

        try {
            const { data: pData } = await supabaseClient.from('projects').upsert([{
                site_name: document.getElementById('site_name').value,
                inspector_name: document.getElementById('inspector_name').value
            }], { onConflict: 'site_name' }).select();

            for(let item of dataStore) {
                for(let key in item.files) {
                    const path = `${item.mode}/${document.getElementById('site_name').value}/${item.date}_${item.loc}_${key}.jpg`;
                    await supabaseClient.storage.from('asbestos_photos').upload(path, item.files[key]);
                    await supabaseClient.from('project_photos').insert([{
                        project_id: pData[0].id,
                        photo_type: `${item.loc}_${key}`,
                        storage_path: path,
                        description: `${item.date} ${item.time}`
                    }]);
                }
            }
            alert("ì„œë²„ ì „ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            dataStore = []; renderList();
        } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "ì„œë²„ ì „ì†¡"; }
    }
</script>
</body>
</html>
